{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<style>
  .jumbotron {
    text-align: center;
    background-color: #f8f9fa;
    padding: 2rem 1rem;
    border: 1px solid #e3e3e3;
    border-radius: 0.3rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  .form-container {
    max-width: 45%;
    margin: 2rem auto;
    padding: 2rem;
    background-color: #ffffff;
    border: 1px solid #e3e3e3;
    border-radius: 0.3rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  .form-group label {
    font-weight: 600;
  }
  .custom-checkbox {
    margin-right: 1rem;
  }
  .form-control {
    width: 100%;
  }
  .btn-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: #fff;
  }
  .btn-primary:hover {
    background-color: #0056b3;
    border-color: #004085;
  }
  .btn-secondary, .btn-danger {
    font-size: 0.875rem;
    border-radius: 0.3rem;
  }
  .btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: #fff;
  }
  .btn-secondary:hover {
    background-color: #5a6268;
    border-color: #545b62;
  }
  .btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    color: #fff;
  }
  .btn-danger:hover {
    background-color: #c82333;
    border-color: #bd2130;
  }
  .image {
    max-width: 100%;
    height: auto;
  }
  .attribute-row, .intersection-row {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
  }
  .attribute-row > * {
    margin-right: 1rem;
    flex: 1;
  }
  .intersection-container {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }
  .intersection-container .form-control,
  .intersection-container .btn {
    margin-bottom: 1rem;
  }
  .intersection-container .btn {
    margin-left: 1rem;
  }
</style>
{% endblock %}

{% block body %}
<div class="jumbotron">
  <h1 class="display-4">Select Protected Attributes</h1>
  <p class="lead">Choose attributes to check for fairness, such as race or gender. Select the attribute and the reference group value. The tool will compare other groups against this reference group to identify biases.</p>
  <hr class="my-4">
  <img class="image" src="{{ url_for('static', filename='chain_2.png') }}" alt="Process Illustration">
</div>

<div class="form-container">
  <h5>Select protected attributes to be audited for bias:</h5>
  <br>
  <form id="attributeForm" action="/metric" method="POST">
    {% for attribute in data %}
    {% if not ('Score' == attribute.name or 'Label_value' == attribute.name) %}
    <div class="attribute-row" id="row_{{ attribute.name }}">
      <div class="custom-control custom-checkbox col-auto" style="flex: 0 0 170px;">
        <input type="checkbox" name="attribute" value="{{ attribute.name }}" class="custom-control-input" id="{{ attribute.name }}">
        <label class="custom-control-label" for="{{ attribute.name }}">{{ attribute.name }}</label>
      </div>
      <select name="privileged_{{ attribute.name }}" class="form-control" style="flex: 0 0 170px;">
        <option>Privileged</option>
        {% for value in attribute.values %}
        <option value="{{ value }}">{{ value }}</option>
        {% endfor %}
      </select>
      <select name="unprivileged_{{ attribute.name }}" class="form-control" style="flex: 0 0 170px;">
        <option>Unprivileged</option>
        {% for value in attribute.values %}
        <option value="{{ value }}">{{ value }}</option>
        {% endfor %}
      </select>
      <button type="button" class="btn btn-secondary add-intersection" data-attribute="{{ attribute.name }}" style="flex: 0 0 220px;">Add Intersectional Group</button>
    </div>
    {% endif %}
    {% endfor %}
    <div class="text-center mt-4">
      <button class="btn btn-primary" id="button" type="button">Next Step</button>
    </div>
  </form>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  $(document).ready(function () {
    $('#attributeForm').on('click', '.add-intersection', function () {
      var attribute = $(this).data('attribute');
      var $row = $(this).closest('.attribute-row');
      var newElements = `
        <div class="attribute-row intersection-row">
          <select name="intersection_attribute_${attribute}" class="form-control" style="flex: 0 0 170px;">
            <option>Select Attribute</option>
            {% for attr in data %}
            <option value="{{ attr.name }}">{{ attr.name }}</option>
            {% endfor %}
          </select>
          <select name="intersection_privileged_${attribute}" class="form-control" style="flex: 0 0 170px;">
            <option>Privileged</option>
            {% for attr in data %}
            {% for val in attr.values %}
            <option value="{{ val }}">{{ val }}</option>
            {% endfor %}
            {% endfor %}
          </select>
          <select name="intersection_unprivileged_${attribute}" class="form-control" style="flex: 0 0 170px;">
            <option>Unprivileged</option>
            {% for attr in data %}
            {% for val in attr.values %}
            <option value="{{ val }}">{{ val }}</option>
            {% endfor %}
            {% endfor %}
          </select>
          <button type="button" class="btn btn-danger remove-intersection" style="flex: 0 0 220px;">Remove</button>
        </div>
        <br>
      `;
      $row.after(newElements);
      $(this).hide();

      $(`select[name="intersection_attribute_${attribute}"]`).change(function () {
        var selectedAttr = $(this).val();
        var privilegedSelect = $(`select[name="intersection_privileged_${attribute}"]`);
        var unprivilegedSelect = $(`select[name="intersection_unprivileged_${attribute}"]`);

        privilegedSelect.html('<option>Privileged</option>');
        unprivilegedSelect.html('<option>Unprivileged</option>');

        {% for attr in data %}
        if (selectedAttr === "{{ attr.name }}") {
          {% for val in attr.values %}
          privilegedSelect.append('<option value="{{ val }}">{{ val }}</option>');
          unprivilegedSelect.append('<option value="{{ val }}">{{ val }}</option>');
          {% endfor %}
        }
        {% endfor %}

        privilegedSelect.change(function () {
          var selectedPrivileged = $(this).val();
          unprivilegedSelect.find('option').show();
          unprivilegedSelect.find(`option[value="${selectedPrivileged}"]`).hide();
        });
      });
    });

    $('#attributeForm').on('click', '.remove-intersection', function () {
      var $row = $(this).closest('.intersection-row');
      $row.prev('.attribute-row').find('.add-intersection').show();
      $row.remove();
    });

    $('#button').click(function () {
      var atts_n_values_picked = [];
      var checkboxes = document.getElementsByName("attribute");
      for (var i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].checked) {
          var value = $('select[name="privileged_' + checkboxes[i].value + '"] option').filter(':selected').val();
          var privileged = $('select[name="privileged_' + checkboxes[i].value + '"] option').filter(':selected').val();
          var unprivileged = $('select[name="unprivileged_' + checkboxes[i].value + '"] option').filter(':selected').val();
          var selected = { "name": checkboxes[i].value, "value": value, "privileged": privileged, "unprivileged": unprivileged };
          atts_n_values_picked.push(selected);

          // Check if there are intersectional attributes
          $(`select[name^="intersection_attribute_${checkboxes[i].value}"]`).each(function() {
            var intersectionAttr = $(this).val();
            var intersectionPrivileged = $(this).closest('.intersection-row').find(`select[name="intersection_privileged_${checkboxes[i].value}"] option:selected`).val();
            var intersectionUnprivileged = $(this).closest('.intersection-row').find(`select[name="intersection_unprivileged_${checkboxes[i].value}"] option:selected`).val();
            if (intersectionAttr && intersectionPrivileged && intersectionUnprivileged) {
              if (!selected["intersection"]) {
                selected["intersection"] = [];
              }
              selected["intersection"].push({
                "attribute": intersectionAttr,
                "privileged": intersectionPrivileged,
                "unprivileged": intersectionUnprivileged
              });
            }
          });
        }
      }
      if (atts_n_values_picked.length > 0) {
        var form = $('#attributeForm');
        var hiddenInput = $('<input>').attr('type', 'hidden').attr('name', 'selected_attributes').attr('value', JSON.stringify(atts_n_values_picked));
        form.append(hiddenInput);
        form.submit();
      } else {
        alert("Please select at least one attribute and its value.");
      }
    });
  });
</script>
{% endblock %}
